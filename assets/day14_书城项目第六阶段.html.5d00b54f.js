import{_ as n,o as s,c as a,a as t}from"./app.a3ab45a4.js";const e={},p=t(`<h1 id="day14-\u4E66\u57CE\u9879\u76EE\u7B2C\u516D\u9636\u6BB5" tabindex="-1"><a class="header-anchor" href="#day14-\u4E66\u57CE\u9879\u76EE\u7B2C\u516D\u9636\u6BB5" aria-hidden="true">#</a> day14.\u4E66\u57CE\u9879\u76EE\u7B2C\u516D\u9636\u6BB5</h1><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u8BFE\u524D\u56DE\u987E<span class="token operator">:</span>
  <span class="token number">1.F</span>ilter\u8FC7\u6EE4\u5668<span class="token operator">-&gt;</span>\u7528\u4E8E\u8FC7\u6EE4\u8BF7\u6C42\u7684\u8FD0\u884C\u5728\u670D\u52A1\u5668\u7684\u5C0F\u7A0B\u5E8F
  <span class="token number">2.F</span>ilter\u8FC7\u6EE4\u5668\u4E2D\u7684\u8FC7\u6EE4\u65B9\u6CD5<span class="token operator">:</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>\u4EE3\u8868\u653E\u884C<span class="token punctuation">,</span>\u5982\u679C\u4E0D\u5199<span class="token punctuation">,</span>\u5C31\u76F4\u63A5\u4F1A\u5361\u5230\u5F53\u524D\u8FC7\u6EE4\u5668\u4E2D
  <span class="token number">3.</span>\u5339\u914D\u89C4\u5219<span class="token operator">:</span>
    a<span class="token punctuation">.</span>\u7CBE\u51C6\u5339\u914D<span class="token operator">:</span>  \u76F4\u63A5\u5199\u7684\u662F\u8BF7\u6C42\u8D44\u6E90\u7684\u8DEF\u5F84
    b<span class="token punctuation">.</span>\u6A21\u7CCA\u5339\u914D<span class="token operator">:</span>
      <span class="token comment">/* -&gt; \u8FC7\u6EE4\u6240\u6709\u8BF7\u6C42 -&gt; \u592A\u7EDD\u5BF9
      /\u76EE\u5F55\u540D/*  -&gt; \u53EA\u6709\u8BBF\u95EE\u8DEF\u5F84\u4E2D\u5E26\u6307\u5B9A\u76EE\u5F55\u540D\u7684\u624D\u80FD\u8D70\u8FD9\u4E2A\u8FC7\u6EE4\u5668  
    c.\u540E\u7F00\u540D\u5339\u914D:
      \u540E\u7F00\u540D  -&gt; \u8BBF\u95EE\u8DEF\u5F84\u4E0A\u5E26\u8FD9\u4E2A\u540E\u7F00\u540D\u7684\u624D\u4F1A\u8D70\u8FC7\u6EE4\u5668
    d.\u540D\u79F0\u5339\u914D:
      \u5199servlet-name\u4E2D\u7684\u540D\u5B57
      
  4.\u591A\u4E2A\u8FC7\u6EE4\u5668\u7684\u6267\u884C\u987A\u5E8F:
    a.\u591A\u4E2A\u8FC7\u6EE4\u5668\u5982\u679C\u90FD\u662F\u4F7F\u7528url-pattern\u914D\u7F6E,\u90A3\u4E48\u54EA\u4E2A\u8FC7\u6EE4\u5668\u5728web.xml\u4E0A\u9762\u5C31\u5148\u8D70\u54EA\u4E2A\u8FC7\u6EE4\u5668
    b.\u5982\u679Curl-pattern\u65B9\u5F0F\u548Cservlet-name\u65B9\u5F0F\u6DF7\u5408\u4F7F\u7528,\u5148\u8D70url-pattern\u8FD9\u79CD
    c.\u6CE8\u89E3\u65B9\u5F0F:  \u770B\u540D\u5B57,\u8C01\u5728\u524D,\u8C01\u5148\u6267\u884C,\u6BD4\u8F83\u540D\u79F0\u5B57\u7B26
  5.\u76D1\u542C\u5668-&gt;\u76D1\u542C\u57DF\u5BF9\u8C61\u4EE5\u53CA\u57DF\u5BF9\u8C61\u5C5E\u6027\u7684\u66F4\u6539

\u4ECA\u65E5\u91CD\u70B9:
  1.\u5B8C\u6210\u8BA2\u5355\u548C\u8BA2\u5355\u9879\u7684\u5B58\u50A8
  2.\u4F1A\u4E8B\u52A1\u7684\u57FA\u672C\u4F7F\u7528-&gt;\u56DE\u987E
  3.\u5728\u8BA2\u5355\u529F\u80FD\u4E2D\u6DFB\u52A0\u4E8B\u52A1
     
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u7B2C\u4E00\u7AE0-\u4E66\u57CE\u9879\u76EE\u7B2C\u516D\u9636\u6BB5" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E00\u7AE0-\u4E66\u57CE\u9879\u76EE\u7B2C\u516D\u9636\u6BB5" aria-hidden="true">#</a> \u7B2C\u4E00\u7AE0.\u4E66\u57CE\u9879\u76EE\u7B2C\u516D\u9636\u6BB5</h1><h2 id="_1-\u767B\u5F55\u68C0\u67E5" tabindex="-1"><a class="header-anchor" href="#_1-\u767B\u5F55\u68C0\u67E5" aria-hidden="true">#</a> 1.\u767B\u5F55\u68C0\u67E5</h2><h3 id="_1-1-\u7528\u6237\u6743\u9650\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#_1-1-\u7528\u6237\u6743\u9650\u8BF4\u660E" aria-hidden="true">#</a> 1.1.\u7528\u6237\u6743\u9650\u8BF4\u660E</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u5F53\u524D\u9879\u76EE\u5982\u679C\u6211\u4EEC\u6CA1\u6709\u767B\u5F55\u7684\u8BDD<span class="token punctuation">,</span>\u4E5F\u53EF\u4EE5\u76F4\u63A5\u8BBF\u95EE\u8D2D\u7269\u8F66<span class="token punctuation">,</span>\u4E5F\u53EF\u4EE5\u64CD\u4F5C\u8D2D\u7269\u8F66<span class="token punctuation">,</span>\u4F46\u662F\u5B9E\u9645\u4E0A\u6211\u4EEC\u4E0D\u5141\u8BB8<span class="token punctuation">;</span>\u53EA\u6709\u767B\u5F55\u4E4B\u540E\u624D\u80FD\u64CD\u4F5C\u8D2D\u7269\u8F66<span class="token punctuation">,</span>\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u52A0\u4E00\u4E2A\u767B\u5F55\u6743\u9650\u7684\u6821\u9A8C

<span class="token number">2.</span>\u4E0D\u5149\u662F\u8D2D\u7269\u8F66<span class="token punctuation">,</span>\u8BA2\u5355\u4E5F\u9700\u8981\u7528\u6237\u6743\u9650
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-\u767B\u5F55\u68C0\u67E5\u529F\u80FD\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-2-\u767B\u5F55\u68C0\u67E5\u529F\u80FD\u6D41\u7A0B" aria-hidden="true">#</a> 1.2.\u767B\u5F55\u68C0\u67E5\u529F\u80FD\u6D41\u7A0B</h3><img src="https://photo.sneoo.com/spring5/202207051131871.png" alt="image-20211203143038950" style="zoom:80%;"><h3 id="_1-3-\u767B\u5F55\u68C0\u67E5\u529F\u80FD\u8FC7\u6EE4\u5668\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#_1-3-\u767B\u5F55\u68C0\u67E5\u529F\u80FD\u8FC7\u6EE4\u5668\u914D\u7F6E" aria-hidden="true">#</a> 1.3.\u767B\u5F55\u68C0\u67E5\u529F\u80FD\u8FC7\u6EE4\u5668\u914D\u7F6E</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u7531\u4E8E\u6211\u4EEC\u8FC7\u6EE4\u7684\u8D44\u6E90\u53EA\u6709\u8D2D\u7269\u8F66\u548C\u8BA2\u5355<span class="token punctuation">,</span>\u5176\u4ED6\u7684\u4E0D\u62E6\u622A<span class="token punctuation">,</span>\u6240\u4EE5\u6211\u4EEC\u5728\u8FC7\u6EE4\u5668\u4E0A\u76F4\u63A5\u6307\u5B9A<span class="token operator">-&gt;</span>\u4F7F\u7528\u76EE\u5F55\u914D\u7F6E
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span><span class="token string">&quot;/protected/*&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u653E\u884C</span>
       filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span>servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u4FEE\u6539<span class="token class-name">CartServlet</span>\u7684url<span class="token operator">-</span>pattern
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
    
\u51E1\u662F\u8BBF\u95EE<span class="token class-name">CartServlet</span>\u7684\u8BF7\u6C42<span class="token punctuation">,</span>\u80AF\u5B9A\u662F\u64CD\u4F5C<span class="token string">&quot;\u8D2D\u7269\u8F66&quot;</span><span class="token punctuation">,</span>\u5C31\u5E94\u8BE5\u5339\u914D\u8FC7\u6EE4\u5668<span class="token punctuation">,</span>\u5148\u53BB\u8FC7\u6EE4\u5668\u8FD9\u8FB9\u8FC7\u6EE4\u4E00\u4E0B<span class="token punctuation">,</span>\u653E\u884C\u4E86<span class="token punctuation">,</span>\u518D\u5230<span class="token class-name">CartServlet</span>\u4E0A\u6267\u884C    
    
<span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span><span class="token string">&quot;/protected/cart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartServlet</span> <span class="token keyword">extends</span> <span class="token class-name">BaseServlet</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
\u5982\u679C\u53EA\u4FEE\u6539servlet\u90A3\u4E48\u9875\u9762\u6240\u6709\u5173\u4E8E\u8D2D\u7269\u8F66\u7684\u90FD\u5E9F\u4E86<span class="token punctuation">,</span>\u6240\u4EE5\u6211\u4EEC\u8FD8\u6709\u4FEE\u6539\u9875\u9762\u4E0A\u7684\u8BF7\u6C42\u8DEF\u5F84
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u4FEE\u6539index<span class="token punctuation">.</span>html<span class="token punctuation">,</span>\u5C06\u6240\u6709\u8BF7\u6C42\u8DEF\u5F84\u4E2D\u5E26cart\u7684\u524D\u9762\u5168\u90E8\u52A0\u4E0A<span class="token keyword">protected</span><span class="token operator">/</span>
\u4FEE\u6539cart<span class="token punctuation">.</span>html<span class="token punctuation">,</span>\u5C06\u6240\u6709\u8BF7\u6C42\u8DEF\u5F84\u4E2D\u5E26cart\u7684\u524D\u9762\u5168\u90E8\u52A0\u4E0A<span class="token keyword">protected</span><span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-\u767B\u5F55\u68C0\u67E5\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_1-4-\u767B\u5F55\u68C0\u67E5\u5B9E\u73B0" aria-hidden="true">#</a> 1.4.\u767B\u5F55\u68C0\u67E5\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u4FEE\u6539<span class="token class-name">LoginFilter</span>\u7C7B<span class="token operator">:</span>
<span class="token number">1.</span>\u5148\u4ECEsession\u57DF\u4E2D\u53D6\u51FA\u7528\u6237\u5BF9\u8C61
<span class="token number">2.</span>\u5982\u679C\u7528\u6237\u5BF9\u8C61\u4E0D\u662F\u7A7A<span class="token punctuation">,</span>\u8BC1\u660E\u7528\u6237\u767B\u5F55\u4E86<span class="token punctuation">,</span>\u5C31\u653E\u884C
<span class="token number">3.</span>\u5982\u679C\u7528\u6237\u5BF9\u8C61\u4E3A\u7A7A<span class="token punctuation">,</span>\u8BC1\u660E\u7528\u6237\u5C1A\u672A\u767B\u5F55
  <span class="token class-name">A</span><span class="token operator">:</span>\u540C\u6B65\u8BF7\u6C42<span class="token punctuation">,</span>\u8F6C\u53D1\u5230\u767B\u5F55\u9875\u9762
  <span class="token class-name">B</span><span class="token operator">:</span>\u5F02\u6B65\u8BF7\u6C42<span class="token punctuation">,</span>\u54CD\u5E94\u5C1A\u672A\u767B\u5F55\u7684\u4FE1\u606F
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span><span class="token string">&quot;/protected/*&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> resp<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.\u7531\u4E8E\u53C2\u6570\u90FD\u662F\u7236\u63A5\u53E3,\u6240\u4EE5\u5148\u5F3A\u8F6C\u4E00\u4E0B</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> resp<span class="token punctuation">;</span>
        <span class="token comment">//2.\u83B7\u53D6session\u4E2D\u7684user\u5BF9\u8C61</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.\u5982\u679Cuser\u4E3A\u7A7A,\u5F00\u59CB\u62E6\u622A</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">/*
            \u6CE8\u610F:
              \u6211\u4EEC\u70B9\u51FB&quot;\u8D2D\u7269\u8F66&quot;\u7684\u65F6\u5019\u662F\u540C\u6B65\u8BF7\u6C42
              \u6211\u4EEC\u70B9\u51FB&quot;\u6DFB\u52A0\u8D2D\u7269\u8F66&quot;\u4EE5\u53CA\u5176\u4ED6\u8D2D\u7269\u8F66\u64CD\u4F5C\u90FD\u662F\u5F02\u6B65\u7684

              \u6211\u4EEC\u5982\u4F55\u5224\u5B9A\u662F\u540C\u6B65\u8FD8\u662F\u5F02\u6B65\u5462?
            \u89E3\u51B3:
              a.\u6211\u4EEC\u70B9\u51FB&quot;\u8D2D\u7269\u8F66&quot;\u6309\u94AE\u5176\u5B9E\u5728index.html\u4E2D\u8C03\u7528\u4E86method=toCartPage\u65B9\u6CD5
                \u5982\u679C\u6211\u4EEC\u83B7\u53D6\u5230\u7684method\u8BF7\u6C42\u53C2\u6570\u662FtoCartPage\u5C31\u662F\u540C\u6B65\u8BF7\u6C42

              b.\u5176\u4ED6\u7684\u8D2D\u7269\u8F66\u64CD\u4F5C\u90FD\u662F\u5F02\u6B65\u7684
           */</span>
          <span class="token comment">//4.\u83B7\u53D6method\u8BF7\u6C42\u53C2\u6570</span>
            <span class="token class-name">String</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;toCartPage&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;/user?method=toLoginPage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token comment">//\u5F02\u6B65\u8BF7\u6C42</span>
                <span class="token class-name">CommonResult</span> commonResult <span class="token operator">=</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;unlogin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u6253\u6210json\u6570\u636E,\u54CD\u5E94\u7ED9\u5BA2\u6237\u7AEF</span>
                <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">writeResult</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>commonResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>\u4FEE\u6539index<span class="token punctuation">.</span>html
<span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">=</span>
 <span class="token comment">//\u6DFB\u52A0\u8D2D\u7269\u8F66</span>
            <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                  \u5C06&quot;\u6DFB\u52A0\u8D2D\u7269\u8F66&quot;\u6309\u94AE\u4E0A\u83B7\u53D6\u7684bookId\u62FF\u8FC7\u6765\u5440&#39;
                  \u53EA\u6709\u5C06\u6309\u94AE\u4E0A\u83B7\u53D6\u7684bookId\u62FF\u5230\u6B64\u65B9\u6CD5\u4E2D
                  \u6211\u4EEC\u624D\u80FD\u53D1\u9001axios\u5F02\u6B65\u8BF7\u6C42,\u5C06bookId\u643A\u5E26\u8FC7\u53BB

                  event.target\u53EF\u4EE5\u83B7\u53D6\u5230\u5F53\u524D\u65B9\u6CD5\u5BF9\u5E94\u4E8B\u4EF6\u6240\u5728\u7684\u6807\u7B7E\u5BF9\u8C61
                 */</span>
                <span class="token keyword">var</span> bookId <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token comment">//\u53D1\u9001\u5F02\u6B65\u8BF7\u6C42</span>
                <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> <span class="token comment">//\u8BF7\u6C42\u65B9\u5F0F</span>
                    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;protected/cart&quot;</span><span class="token punctuation">,</span>    <span class="token comment">//\u8BF7\u6C42\u8DEF\u5F84</span>
                    <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token comment">//\u8BF7\u6C42\u53C2\u6570</span>
                        <span class="token string-property property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;addCart&quot;</span><span class="token punctuation">,</span>
                        <span class="token string-property property">&quot;bookId&quot;</span><span class="token operator">:</span> bookId
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//\u63D0\u793A\u7528\u6237\u6DFB\u52A0\u6210\u529F</span>
                        layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//\u6DFB\u52A0\u4E4B\u540E\u9A6C\u4E0A\u518D\u91CD\u65B0\u83B7\u53D6\u4E00\u4E0B\u603B\u6570\u91CF</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message<span class="token operator">==</span><span class="token string">&quot;unlogin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token comment">/*
                              location\u5BF9\u8C61,\u8FD9\u4E2A\u5BF9\u8C61\u53EF\u4EE5\u64CD\u4F5C\u5730\u5740\u680F\u7684\u5185\u5BB9

                              location\u662Fwindow\u5BF9\u8C61\u4E2D\u7684,\u5C5E\u4E8EBOM\u5BF9\u8C61

                              window\u5BF9\u8C61\u4E0D\u7528\u5199,\u5C31\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528window\u5BF9\u8C61\u4E2D\u7684\u5176\u4ED6\u5BF9\u8C61

                              \u4F7F\u7528location\u4E2D\u7684href\u5C5E\u6027,\u53EF\u4EE5\u76F4\u63A5\u64CD\u4F5C\u6D4F\u89C8\u5668\u5730\u5740\u680F\u4E2D\u7684\u5185\u5BB9
                            */</span>
                            location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;user?method=toLoginPage&quot;</span><span class="token punctuation">;</span>

                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-\u767B\u5F55\u68C0\u67E5\u8D2D\u7269\u8F66\u663E\u793A\u6570\u91CF\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_1-5-\u767B\u5F55\u68C0\u67E5\u8D2D\u7269\u8F66\u663E\u793A\u6570\u91CF\u95EE\u9898" aria-hidden="true">#</a> 1.5.\u767B\u5F55\u68C0\u67E5\u8D2D\u7269\u8F66\u663E\u793A\u6570\u91CF\u95EE\u9898</h3><img src="https://photo.sneoo.com/spring5/202207051131873.png" alt="image-20211202205632021" style="zoom:80%;"><img src="https://photo.sneoo.com/spring5/202207051131874.png" alt="image-20211202210358590" style="zoom:80%;"><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>\u4FEE\u6539index<span class="token punctuation">.</span><span class="token function">html\u4E2D\u7684getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\u51FD\u6570
<span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">==</span>
    
  <span class="token comment">/*
    \u83B7\u53D6\u6DFB\u52A0\u8D2D\u7269\u8F66\u7684\u603B\u5546\u54C1\u6570\u91CF
  */</span>
  <span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u670D\u52A1\u5668\u53D1\u9001\u8BF7\u6C42,\u83B7\u53D6\u8D2D\u7269\u8F66\u4E2D\u7684\u5546\u54C1\u6570\u91CF</span>
      <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> <span class="token comment">//\u8BF7\u6C42\u65B9\u5F0F</span>
          <span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">&quot;protected/cart&quot;</span><span class="token punctuation">,</span>    <span class="token comment">//\u8BF7\u6C42\u8DEF\u5F84</span>
          <span class="token literal-property property">params</span><span class="token operator">:</span><span class="token punctuation">{</span>   <span class="token comment">//\u8BF7\u6C42\u53C2\u6570</span>
              <span class="token string-property property">&quot;method&quot;</span><span class="token operator">:</span><span class="token string">&quot;getTotalCount&quot;</span> <span class="token comment">//\u8C03\u7528\u83B7\u53D6\u5546\u54C1\u603B\u6570\u91CF\u7684\u65B9\u6CD5</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message<span class="token operator">==</span><span class="token string">&quot;unlogin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
              <span class="token comment">//console.log(response.data);</span>
              <span class="token comment">//\u670D\u52A1\u5668\u54CD\u5E94\u56DE\u6765\u7684\u8D2D\u4E70\u6570\u91CF,\u5C55\u793A\u5728\u9875\u9762\u4E2D</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>resultData
          <span class="token punctuation">}</span>

      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-\u8BA2\u5355\u529F\u80FD-\u63D0\u4EA4\u8BA2\u5355\u7ED3\u8D26-\u51C6\u5907\u5DE5\u4F5C" tabindex="-1"><a class="header-anchor" href="#_2-\u8BA2\u5355\u529F\u80FD-\u63D0\u4EA4\u8BA2\u5355\u7ED3\u8D26-\u51C6\u5907\u5DE5\u4F5C" aria-hidden="true">#</a> 2.\u8BA2\u5355\u529F\u80FD_\u63D0\u4EA4\u8BA2\u5355\u7ED3\u8D26(\u51C6\u5907\u5DE5\u4F5C)</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u8868\u5173\u7CFB\u56DE\u987E<span class="token operator">:</span>

  \u4E00\u5BF9\u4E00   <span class="token operator">-&gt;</span> \u4E24\u5F20\u8868\u600E\u4E48\u770B\u90FD\u662F\u4E00\u5BF9\u4E00
  \u4E00\u5BF9\u591A   <span class="token operator">-&gt;</span> \u6BD4\u5982<span class="token operator">:</span>\u5546\u54C1\u5206\u7C7B\u8868  \u5546\u54C1\u4FE1\u606F\u8868
             \u4ECE\u5206\u7C7B\u8868\u5F80\u4FE1\u606F\u8868\u770B<span class="token operator">-&gt;</span> \u4E00\u4E2A\u5206\u7C7B\u5305\u542B\u4E86\u591A\u4E2A\u5546\u54C1 <span class="token operator">-&gt;</span> \u4E00\u5BF9\u591A
             \u4ECE\u4FE1\u606F\u8868\u5F80\u5206\u7C7B\u8868\u770B<span class="token operator">-&gt;</span> \u591A\u4E2A\u5546\u54C1\u4F1A\u5C5E\u4E8E\u540C\u4E00\u4E2A\u5206\u7C7B <span class="token operator">-&gt;</span> \u591A\u5BF9\u4E00
              
             \u5206\u6E05\u695A<span class="token operator">:</span>\u8C01\u662F\u4E3B\u8868<span class="token punctuation">(</span>\u5206\u7C7B\u8868<span class="token punctuation">)</span><span class="token punctuation">,</span>\u8C01\u662F\u4ECE\u8868<span class="token punctuation">(</span>\u5546\u54C1\u8868<span class="token punctuation">)</span>
                 
            \u600E\u4E48\u5C06\u4E24\u4E2A\u8868\u8FDE\u63A5\u8D77\u6765<span class="token operator">-&gt;</span>\u5EFA\u7ACB\u5916\u952E\u7EA6\u675F<span class="token punctuation">,</span>\u4ECE\u4ECE\u8868\u4E2D\u8BBE\u7F6E\u5916\u952E<span class="token punctuation">,</span>\u5916\u952E\u5176\u5B9E\u4FDD\u5B58\u7684\u662F\u4E3B\u8868\u7684\u4E3B\u952E
                 
  \u591A\u5BF9\u591A  <span class="token operator">-&gt;</span> \u6BD4\u5982<span class="token operator">:</span> \u89D2\u8272\u8868\u548C\u6F14\u5458\u8868
      
            \u6B63\u7740\u770B<span class="token punctuation">,</span>\u53CD\u7740\u770B\u90FD\u662F\u4E00\u5BF9\u591A
      
            \u9700\u8981\u4E2D\u95F4\u8868<span class="token operator">:</span>\u4FDD\u5B58\u7684\u662F\u4E24\u4E2A\u8868\u7684\u4E3B\u952E
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-\u521B\u5EFA\u8BA2\u5355\u8868" tabindex="-1"><a class="header-anchor" href="#_2-1-\u521B\u5EFA\u8BA2\u5355\u8868" aria-hidden="true">#</a> 2.1.\u521B\u5EFA\u8BA2\u5355\u8868</h3><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>#\u8BA2\u5355\u8868
CREATE TABLE t_order(
	order_id INT PRIMARY KEY AUTO_INCREMENT,
	order_sequence VARCHAR(200),
	create_time VARCHAR(100),  
	total_count INT,
	total_amount DOUBLE,  
	order_status INT,
	user_id INT
);

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>\u5B57\u6BB5\u540D</th><th>\u5B57\u6BB5\u4F5C\u7528</th></tr></thead><tbody><tr><td>order_id</td><td>\u4E3B\u952E</td></tr><tr><td>order_sequence</td><td>\u8BA2\u5355\u53F7</td></tr><tr><td>create_time</td><td>\u8BA2\u5355\u521B\u5EFA\u65F6\u95F4 -&gt;\u4F7F\u7528Date,\u5C06Date\u6309\u7167\u6307\u5B9A\u7684\u683C\u5F0F\u8F6C\u6210String\u5B58\u8FDB\u6765</td></tr><tr><td>total_count</td><td>\u8BA2\u5355\u4E2D\u5546\u54C1\u7684\u603B\u6570\u91CF-&gt;\u8D2D\u7269\u8F66\u4E2D\u7684\u603B\u6570\u91CF</td></tr><tr><td>total_amount</td><td>\u8BA2\u5355\u7684\u603B\u91D1\u989D -&gt; \u8D2D\u7269\u8F66\u4E2D\u7684\u603B\u91D1\u989D</td></tr><tr><td>order_status</td><td>\u8BA2\u5355\u7684\u72B6\u6001 -&gt;\u8868\u793A\u7684\u662F\u672A\u4ED8\u6B3E,\u5DF2\u4ED8\u6B3E\u7B49\u72B6\u6001</td></tr><tr><td>user_id</td><td>\u4E0B\u5355\u7684\u7528\u6237\u7684id-&gt;\u83B7\u53D6User\u5BF9\u8C61,\u83B7\u53D6User\u5BF9\u8C61\u4E2D\u7684userid,\u4E3A\u6B64\u5217\u8D4B\u503C</td></tr></tbody></table><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u867D\u7136order_sequence\u4E5F\u662F\u4E00\u4E2A\u4E0D\u91CD\u590D\u7684\u6570\u503C\uFF0C\u4F46\u662F\u4E0D\u4F7F\u7528\u5B83\u4F5C\u4E3A\u4E3B\u952E\u3002\u6570\u636E\u5E93\u8868\u7684\u4E3B\u952E\u8981\u4F7F\u7528\u6CA1\u6709\u4E1A\u52A1\u529F\u80FD\u7684\u5B57\u6BB5\u6765\u62C5\u4EFB\u3002
<span class="token number">2.</span>\u8BA2\u5355\u7684\u72B6\u6001
  a<span class="token punctuation">.</span>\u5F85\u652F\u4ED8\uFF08\u4E66\u57CE\u9879\u76EE\u4E2D\u6682\u4E0D\u8003\u8651\uFF09
  b<span class="token punctuation">.</span>\u5DF2\u652F\u4ED8\uFF0C\u5F85\u53D1\u8D27\uFF1A<span class="token number">0</span>
  c<span class="token punctuation">.</span>\u5DF2\u53D1\u8D27\uFF1A<span class="token number">1</span>
  d<span class="token punctuation">.</span>\u786E\u8BA4\u6536\u8D27\uFF1A<span class="token number">2</span>
  e<span class="token punctuation">.</span>\u53D1\u8D77\u9000\u6B3E\u6216\u9000\u8D27\uFF08\u4E66\u57CE\u9879\u76EE\u4E2D\u6682\u4E0D\u8003\u8651\uFF09
<span class="token number">3.</span>user_id
  a<span class="token punctuation">.</span>\u4ECE\u903B\u8F91\u548C\u8868\u7ED3\u6784\u7684\u89D2\u5EA6\u6765\u8BF4\uFF0C\u8FD9\u5176\u5B9E\u662F\u4E00\u4E2A\u5916\u952E\u3002
  b<span class="token punctuation">.</span>\u4F46\u662F\u5F00\u53D1\u8FC7\u7A0B\u4E2D\u5EFA\u8BAE\u5148\u4E0D\u8981\u52A0\u5916\u952E\u7EA6\u675F\uFF1A\u56E0\u4E3A\u5F00\u53D1\u8FC7\u7A0B\u4E2D\u6570\u636E\u5C1A\u4E0D\u5B8C\u6574\uFF0C\u52A0\u4E86\u5916\u952E\u7EA6\u675F\u5F00\u53D1\u8FC7\u7A0B\u4E2D\u4F7F\u7528\u6D4B\u8BD5\u6570\u636E\u975E\u5E38\u4E0D\u65B9\u4FBF\uFF0C\u5EFA\u8BAE\u9879\u76EE\u9884\u53D1\u5E03\u65F6\u6DFB\u52A0\u5916\u952E\u7EA6\u675F\u6D4B\u8BD5\u3002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-\u521B\u5EFA\u8BA2\u5355\u9879\u8868" tabindex="-1"><a class="header-anchor" href="#_2-2-\u521B\u5EFA\u8BA2\u5355\u9879\u8868" aria-hidden="true">#</a> 2.2.\u521B\u5EFA\u8BA2\u5355\u9879\u8868</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u8BA2\u5355\u9879\u4E2D\u7684\u5185\u5BB9<span class="token punctuation">,</span>\u5C31\u662F\u8D2D\u7269\u9879\u4E2D\u7684\u5185\u5BB9
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE t_order_item(
	item_id INT PRIMARY KEY AUTO_INCREMENT,
	book_name VARCHAR(20),
	price DOUBLE,
	img_path VARCHAR(50),
	item_count INT,
	item_amount DOUBLE,
	order_id VARCHAR(20)
);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>\u5B57\u6BB5\u540D\u79F0</th><th>\u5B57\u6BB5\u4F5C\u7528</th></tr></thead><tbody><tr><td>item_id</td><td>\u4E3B\u952E</td></tr><tr><td>book_name</td><td>\u4E66\u540D-&gt;\u83B7\u53D6\u8D2D\u7269\u9879\u4E2D\u7684name,\u4E3A\u6B64\u5217\u8D4B\u503C</td></tr><tr><td>price</td><td>\u5355\u4EF7-&gt;\u83B7\u53D6\u8D2D\u7269\u9879\u4E2D\u7684price,\u4E3A\u6B64\u5217\u8D4B\u503C</td></tr><tr><td>img_path</td><td>\u56FE\u7247\u8DEF\u5F84-&gt;\u83B7\u53D6\u8D2D\u7269\u9879\u4E2D\u7684imgPath,\u4E3A\u6B64\u5217\u8D4B\u503C</td></tr><tr><td>item_count</td><td>\u5F53\u524D\u8BA2\u5355\u9879\u7684\u6570\u91CF -&gt; -&gt;\u83B7\u53D6\u8D2D\u7269\u9879\u4E2D\u7684count,\u4E3A\u6B64\u5217\u8D4B\u503C</td></tr><tr><td>item_amount</td><td>\u5F53\u524D\u8BA2\u5355\u9879\u7684\u91D1\u989D-&gt;-&gt;\u83B7\u53D6\u8D2D\u7269\u9879\u4E2D\u7684amount,\u4E3A\u6B64\u5217\u8D4B\u503C</td></tr><tr><td>order_id</td><td>\u5F53\u524D\u8BA2\u5355\u9879\u5173\u8054\u7684\u8BA2\u5355\u8868\u7684\u4E3B\u952E(\u5916\u952E)</td></tr></tbody></table><h3 id="_2-3-\u521B\u5EFAorder\u8BA2\u5355javabean" tabindex="-1"><a class="header-anchor" href="#_2-3-\u521B\u5EFAorder\u8BA2\u5355javabean" aria-hidden="true">#</a> 2.3.\u521B\u5EFAOrder\u8BA2\u5355javabean</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> orderId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderSequence<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> totalCount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> totalAmount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> orderStatus<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-\u521B\u5EFAorderitem\u8BA2\u5355\u9879javabean" tabindex="-1"><a class="header-anchor" href="#_2-4-\u521B\u5EFAorderitem\u8BA2\u5355\u9879javabean" aria-hidden="true">#</a> 2.4.\u521B\u5EFAOrderItem\u8BA2\u5355\u9879javabean</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderItem</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> itemId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> bookName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> imgPath<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> itemCount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> itemAmount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> orderId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-\u8BA2\u5355\u529F\u80FD-\u63D0\u4EA4\u8BA2\u5355\u7ED3\u8D26" tabindex="-1"><a class="header-anchor" href="#_3-\u8BA2\u5355\u529F\u80FD-\u63D0\u4EA4\u8BA2\u5355\u7ED3\u8D26" aria-hidden="true">#</a> 3.\u8BA2\u5355\u529F\u80FD_\u63D0\u4EA4\u8BA2\u5355\u7ED3\u8D26</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u521B\u5EFA
    <span class="token class-name">OrderServlet</span>  
    <span class="token class-name">OrderService</span> <span class="token class-name">OrderServiceImpl</span>   
    <span class="token class-name">OrderDao</span>  <span class="token class-name">OrderDaoImpl</span>      
    <span class="token class-name">OrderItemDao</span>   <span class="token class-name">OrderItemDaoImpl</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://photo.sneoo.com/spring5/202207051131875.png" alt="1656035183729"></p><p><img src="https://photo.sneoo.com/spring5/202207051131876.png" alt="1656036008794"></p><h3 id="_3-1-\u4FEE\u6539cart-html" tabindex="-1"><a class="header-anchor" href="#_3-1-\u4FEE\u6539cart-html" aria-hidden="true">#</a> 3.1.\u4FEE\u6539cart.html</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>\u4FEE\u6539&quot;\u53BB\u7ED3\u8D26&quot;\u7684\u8BF7\u6C42\u5730\u5740
================================
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pay<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>protected/order?method=checkout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u53BB\u7ED3\u8D26<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-orderservlet\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_3-2-orderservlet\u5B9E\u73B0" aria-hidden="true">#</a> 3.2.OrderServlet\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u4FEE\u6539<span class="token class-name">LoginFilter</span>\u6BD4\u8F83<span class="token operator">-&gt;</span>\u56E0\u4E3A\u7ED3\u8D26\u529F\u80FD\u4E5F\u662F\u540C\u6B65
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;toCartPage&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">&quot;checkout&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span><span class="token string">&quot;/protected/order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServlet</span> <span class="token keyword">extends</span> <span class="token class-name">BaseServlet</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderService</span> orderService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u8BA2\u5355\u7ED3\u7B97\u529F\u80FD
     *
     * <span class="token keyword">@param</span> <span class="token parameter">request</span>
     * <span class="token keyword">@param</span> <span class="token parameter">response</span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
          \u7531\u4E8E\u8BA2\u5355\u4E2D\u7684\u6570\u636E\u90FD\u662F\u4ECE\u8D2D\u7269\u8F66\u4E2D\u6765\u7684
          \u6240\u4EE5\u6211\u4EEC\u9700\u8981\u83B7\u53D6\u51FACart\u5BF9\u8C61
          
          \u53C8\u56E0\u4E3A\u8BA2\u5355\u9700\u8981\u7528\u6237\u7684\u652F\u6301,\u6240\u4EE5\u9700\u8981User\u5BF9\u8C61
        */</span>
        
        <span class="token comment">//1.\u4ECEsession\u4E2D\u83B7\u53D6\u8D2D\u7269\u8F66\u5BF9\u8C61</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cart</span> cart <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Cart</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.\u4ECEsession\u83B7\u53D6\u7528\u6237\u4FE1\u606F</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.\u8C03\u7528service\u5C42\u7684\u65B9\u6CD5,\u8FDB\u884C\u8BA2\u5355\u7ED3\u7B97,\u5E76\u4E14\u83B7\u53D6\u8BA2\u5355\u7684\u5E8F\u5217\u53F7</span>
        <span class="token class-name">String</span> orderSequence <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">checkout</span><span class="token punctuation">(</span>cart<span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.\u5C06\u8BA2\u5355\u5E8F\u5217\u53F7\u5B58\u50A8\u5230\u57DF\u4E2D,\u8DF3\u8F6Ccheckout.html\u9875\u9762</span>
        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orderSequence&quot;</span><span class="token punctuation">,</span>orderSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">processTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;cart/checkout.html&quot;</span><span class="token punctuation">,</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-orderservice\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_3-3-orderservice\u5B9E\u73B0" aria-hidden="true">#</a> 3.3.OrderService\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">Cart</span> cart<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderDao</span> orderDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">Cart</span> cart<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.\u521B\u5EFA\u8BA2\u5355\u5BF9\u8C61</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.\u751F\u6210\u4E00\u4E2A\u552F\u4E00\u7684\u8BA2\u5355\u53F7(\u4F7F\u7528UUID)</span>
        <span class="token class-name">String</span> orderSequence <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.\u5C06\u751F\u6210\u7684\u8BA2\u5355\u53F7\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderSequence</span><span class="token punctuation">(</span>orderSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4.\u521B\u5EFA\u4E0B\u5355\u7684\u65F6\u95F4,\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D-&gt;\u5F53\u524D\u65F6\u95F4</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> createTime <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>createTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.\u8BBE\u7F6EOrder\u7684\u8D2D\u4E70\u6570\u91CF,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
        order<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//6.\u8BBE\u7F6EOrder\u7684\u603B\u91D1\u989D,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
        order<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          7.\u8BBE\u7F6EOrder\u7684\u8BA2\u5355\u72B6\u6001 -&gt; \u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27:0

            \u6CE8\u610F:\u5C06\u6765\u5982\u679C\u5199\u72B6\u6001\u7801\u76F4\u63A5\u51990,\u4E0D\u597D
                \u5982\u679C\u5C06\u6765\u9879\u76EE\u7ECF\u7406\u6216\u8005\u4EA7\u54C1\u8BF4\u4E86:0\u4E0D\u4EE3\u8868\u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27\u4E86,\u54B1\u4EEC\u8FD8\u5F97\u6539\u8FD9\u4E2A0
                \u6240\u4EE5,\u72B6\u6001\u7801\u4E0D\u5E94\u8BE5\u5199\u6B7B

            \u89E3\u51B3:\u521B\u5EFA\u4E00\u4E2A\u7C7B,\u5728\u91CC\u9762\u521B\u5EFA\u72B6\u6001\u7801,\u5230\u65F6\u5019\u5982\u679C\u6574\u6570\u4EE3\u8868\u7684\u72B6\u6001\u6539\u4E86,\u6211\u4EEC\u76F4\u63A5\u5728\u6B64\u7C7B\u4E2D
                 \u6539
                 \u6B64\u5904\u7684\u4EE3\u7801\u4E0D\u7528\u6539\u4E86
         */</span>
         order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusCode</span><span class="token punctuation">.</span>YIZHIFU<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//8.\u8BBE\u7F6EOrder\u7684\u7528\u6237\u4E3B\u952E</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//9.\u8C03\u7528dao\u6210\u7684insertOrder\u65B9\u6CD5,\u4F20\u9012Order\u5BF9\u8C61</span>
        orderDao<span class="token punctuation">.</span><span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderSequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u5728utils\u5305\u4E2D\u521B\u5EFA<span class="token class-name">OrderStatusCode</span>\u7C7B<span class="token operator">:</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStatusCode</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> YIZHIFU <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> YIFAHUO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> YISHOUHUO <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-orderdao\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_3-4-orderdao\u5B9E\u73B0" aria-hidden="true">#</a> 3.4.OrderDao\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderDao</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryRunner</span> qr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryRunner</span><span class="token punctuation">(</span><span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * \u6DFB\u52A0\u8BA2\u5355\u65B9\u6CD5
     * <span class="token keyword">@param</span> <span class="token parameter">order</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into t_order values (?,?,?,?,?,?,?)&quot;</span><span class="token punctuation">;</span>
        qr<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                order<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-\u8BA2\u5355\u529F\u80FD-\u5B58\u50A8\u8BA2\u5355\u9879" tabindex="-1"><a class="header-anchor" href="#_4-\u8BA2\u5355\u529F\u80FD-\u5B58\u50A8\u8BA2\u5355\u9879" aria-hidden="true">#</a> 4.\u8BA2\u5355\u529F\u80FD_\u5B58\u50A8\u8BA2\u5355\u9879</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u8BA2\u5355\u9879\u7684\u5185\u5BB9\u662F\u8D2D\u7269\u8F66\u8D2D\u7269\u9879\u51B3\u5B9A\u7684
 
\u6240\u4EE5\u6211\u4EEC\u5728\u63D0\u4EA4\u8BA2\u5355\u4E4B\u540E<span class="token punctuation">,</span>\u9A6C\u4E0A\u5C31\u8981\u4ECE\u8D2D\u7269\u9879\u4E2D\u83B7\u53D6\u53C2\u6570\u4FDD\u5B58\u5230\u8BA2\u5355\u9879\u7684\u5BF9\u8C61\u4E2D<span class="token punctuation">,</span>\u7136\u540E\u5C06\u8BA2\u5355\u9879\u5BF9\u8C61\u5B58\u5165\u5230\u6570\u636E\u5E93\u4E2D
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1-\u4FEE\u6539orderservice\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-1-\u4FEE\u6539orderservice\u5B9E\u73B0" aria-hidden="true">#</a> 4.1.\u4FEE\u6539OrderService\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderDao</span> orderDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderItemDao</span> orderItemDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">Cart</span> cart<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.\u521B\u5EFA\u8BA2\u5355\u5BF9\u8C61</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.\u751F\u6210\u4E00\u4E2A\u552F\u4E00\u7684\u8BA2\u5355\u53F7(\u4F7F\u7528UUID)</span>
        <span class="token class-name">String</span> orderSequence <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.\u5C06\u751F\u6210\u7684\u8BA2\u5355\u53F7\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderSequence</span><span class="token punctuation">(</span>orderSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4.\u521B\u5EFA\u4E0B\u5355\u7684\u65F6\u95F4,\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D-&gt;\u5F53\u524D\u65F6\u95F4</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> createTime <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>createTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.\u8BBE\u7F6EOrder\u7684\u8D2D\u4E70\u6570\u91CF,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
        order<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//6.\u8BBE\u7F6EOrder\u7684\u603B\u91D1\u989D,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
        order<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          7.\u8BBE\u7F6EOrder\u7684\u8BA2\u5355\u72B6\u6001 -&gt; \u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27:0

            \u6CE8\u610F:\u5C06\u6765\u5982\u679C\u5199\u72B6\u6001\u7801\u76F4\u63A5\u51990,\u4E0D\u597D
                \u5982\u679C\u5C06\u6765\u9879\u76EE\u7ECF\u7406\u6216\u8005\u4EA7\u54C1\u8BF4\u4E86:0\u4E0D\u4EE3\u8868\u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27\u4E86,\u54B1\u4EEC\u8FD8\u5F97\u6539\u8FD9\u4E2A0
                \u6240\u4EE5,\u72B6\u6001\u7801\u4E0D\u5E94\u8BE5\u5199\u6B7B

            \u89E3\u51B3:\u521B\u5EFA\u4E00\u4E2A\u7C7B,\u5728\u91CC\u9762\u521B\u5EFA\u72B6\u6001\u7801,\u5230\u65F6\u5019\u5982\u679C\u6574\u6570\u4EE3\u8868\u7684\u72B6\u6001\u6539\u4E86,\u6211\u4EEC\u76F4\u63A5\u5728\u6B64\u7C7B\u4E2D
                 \u6539
                 \u6B64\u5904\u7684\u4EE3\u7801\u4E0D\u7528\u6539\u4E86
         */</span>
         order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusCode</span><span class="token punctuation">.</span>YIZHIFU<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//8.\u8BBE\u7F6EOrder\u7684\u7528\u6237\u4E3B\u952E</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//9.\u8C03\u7528dao\u6210\u7684insertOrder\u65B9\u6CD5,\u4F20\u9012Order\u5BF9\u8C61</span>
        <span class="token class-name">Integer</span> key <span class="token operator">=</span> orderDao<span class="token punctuation">.</span><span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=================\u4EE5\u4E0B\u662F\u8BA2\u5355\u9879\u7684\u4EE3\u7801================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
          10.\u7531\u4E8E\u8BA2\u5355\u9879\u4E2D\u7684\u5185\u5BB9\u53D6\u51B3\u4E8E\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u5185\u5BB9
             \u6240\u4EE5\u9700\u8981\u5148\u83B7\u53D6\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u6570\u636E
             \u800C\u4E14\u6709\u51E0\u4E2A\u8D2D\u7269\u9879\u5C31\u5E94\u8BE5\u6709\u51E0\u4E2A\u8BA2\u5355\u9879
         */</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItem</span><span class="token punctuation">&gt;</span></span> cartItemCollection <span class="token operator">=</span> cart<span class="token punctuation">.</span><span class="token function">getCartItemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u6709\u51E0\u4E2A\u8D2D\u7269\u9879,\u5C31\u5E94\u8BE5\u6709\u51E0\u4E2A\u8BA2\u5355\u9879</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItem</span> cartItem <span class="token operator">:</span> cartItemCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u521B\u5EFA\u8BA2\u5355\u9879\u5BF9\u8C61</span>
            <span class="token class-name">OrderItem</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8BBE\u7F6E\u8BA2\u5355\u9879OrderItem\u4E2D\u7684\u5C5E\u6027\u503C,\u5C5E\u6027\u503C\u4ECE\u8D2D\u7269\u9879\u4E2D\u53D6,\u7136\u540E\u653E\u5230OrderItem\u4E2D</span>

            <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u4E66\u540D</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setBookName</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5355\u4EF7</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u56FE\u7247\u8DEF\u5F84</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setImgPath</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getImgPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8D2D\u4E70\u6570\u91CF</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setItemCount</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5C0F\u8BA1\u91D1\u989D</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setItemAmount</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/*
              orderItem\u4E2D\u7684order_id\u5916\u952E\u600E\u4E48\u4FDD\u5B58?
              \u83B7\u53D6\u6700\u540E\u4E00\u6B21\u65B0\u589E\u7684\u8BA2\u5355id
              \u65B0\u63D0\u4EA4\u4E86\u90A3\u4E2A\u8BA2\u5355,\u76F4\u63A5\u628A\u8FD9\u4E2A\u8BA2\u5355\u7684id\u83B7\u53D6\u51FA\u6765\u653E\u5230\u8BA2\u5355\u9879\u7684\u5916\u952E\u4E2D
             */</span>
            <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8BA2\u5355\u7684\u5916\u952E (\u8BA2\u5355\u6570\u636E\u8868\u7684\u4E3B\u952E)</span>
            orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//\u8C03\u7528OrderItemDao\u4E2D\u7684\u6DFB\u52A0\u8BA2\u5355\u9879\u7684\u65B9\u6CD5</span>
            orderItemDao<span class="token punctuation">.</span><span class="token function">insertOrderItem</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> orderSequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> category<span class="token punctuation">(</span>
  cid <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  cname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> category <span class="token punctuation">(</span>cname<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;\u670D\u88C5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> LAST_INSERT_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- \u67E5\u8BE2\u6700\u540E\u4E00\u6B21\u63D2\u5165\u7684\u6570\u636Eid</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-\u4FEE\u6539orderdao\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-2-\u4FEE\u6539orderdao\u5B9E\u73B0" aria-hidden="true">#</a> 4.2.\u4FEE\u6539OrderDao\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into t_order values (?,?,?,?,?,?,?)&quot;</span><span class="token punctuation">;</span>
        qr<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                order<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        

        <span class="token comment">//===============\u65B0\u6DFB\u52A0\u7684=============</span>
        <span class="token comment">//\u83B7\u53D6\u65B0\u589E\u7684\u4E3B\u952E</span>
        <span class="token class-name">String</span> sqlKey <span class="token operator">=</span> <span class="token string">&quot;select last_insert_id()&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          \u6267\u884Cselect last_insert_id()\u9700\u8981\u8F6C\u6210BigInteger
          \u5F3A\u8F6C\u6210BigInteger\u8C03\u7528intValue()\u8F6C\u6210Integer
         */</span>
        <span class="token class-name">Integer</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">)</span> qr<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sqlKey<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScalarHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-\u521B\u5EFAorderitemdao\u5E76\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-3-\u521B\u5EFAorderitemdao\u5E76\u5B9E\u73B0" aria-hidden="true">#</a> 4.3.\u521B\u5EFAOrderItemDao\u5E76\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderItemDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderItemDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderItemDao</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryRunner</span> qr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryRunner</span><span class="token punctuation">(</span><span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
<span class="token comment">//\u5199\u5165\u4E2D\u95F4\u8868\u7684SQL\u6570\u636E</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into t_order_item values(?,?,?,?,?,?,?)&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5BF9\u8C61\u6570\u7EC4\uFF0C\u5B58\u50A8\u4E2D\u95F4\u8868\u95EE\u53F7\u5360\u4F4D\u7B26\u6570\u636E</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>orderItem<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                orderItem<span class="token punctuation">.</span><span class="token function">getImgPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getItemAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//\u6267\u884CSQL\u8BED\u53E5</span>
        qr<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-\u4FEE\u6539checkout-html\u663E\u793A\u57DF\u4E2D\u7684\u8BA2\u5355\u53F7" tabindex="-1"><a class="header-anchor" href="#_4-4-\u4FEE\u6539checkout-html\u663E\u793A\u57DF\u4E2D\u7684\u8BA2\u5355\u53F7" aria-hidden="true">#</a> 4.4.\u4FEE\u6539checkout.html\u663E\u793A\u57DF\u4E2D\u7684\u8BA2\u5355\u53F7</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>\u4F60\u7684\u8BA2\u5355\u5DF2\u7ED3\u7B97\uFF0C\u8BA2\u5355\u53F7\u4E3A:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>oid<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>\${orderSequence}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-\u8BA2\u5355\u529F\u80FD-\u63D0\u4EA4\u8BA2\u5355\u6E05\u7A7A\u8D2D\u7269\u8F66" tabindex="-1"><a class="header-anchor" href="#_5-\u8BA2\u5355\u529F\u80FD-\u63D0\u4EA4\u8BA2\u5355\u6E05\u7A7A\u8D2D\u7269\u8F66" aria-hidden="true">#</a> 5.\u8BA2\u5355\u529F\u80FD_\u63D0\u4EA4\u8BA2\u5355\u6E05\u7A7A\u8D2D\u7269\u8F66</h2><h3 id="_5-1-\u4FEE\u6539orderservlet" tabindex="-1"><a class="header-anchor" href="#_5-1-\u4FEE\u6539orderservlet" aria-hidden="true">#</a> 5.1.\u4FEE\u6539OrderServlet</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> cart<span class="token punctuation">.</span><span class="token function">getCartItemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 cart<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u7B2C\u4E8C\u7AE0-\u4E8B\u52A1\u5728\u4E66\u57CE\u4E2D\u7684\u64CD\u4F5C" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E8C\u7AE0-\u4E8B\u52A1\u5728\u4E66\u57CE\u4E2D\u7684\u64CD\u4F5C" aria-hidden="true">#</a> \u7B2C\u4E8C\u7AE0.\u4E8B\u52A1\u5728\u4E66\u57CE\u4E2D\u7684\u64CD\u4F5C</h1><h2 id="_1-\u672A\u52A0\u4E8B\u52A1\u65F6\u51FA\u73B0\u7684bug" tabindex="-1"><a class="header-anchor" href="#_1-\u672A\u52A0\u4E8B\u52A1\u65F6\u51FA\u73B0\u7684bug" aria-hidden="true">#</a> 1.\u672A\u52A0\u4E8B\u52A1\u65F6\u51FA\u73B0\u7684bug</h2><h3 id="_1-1-\u5728orderserviceimpl\u4E2D\u52A0\u5F02\u5E38\u4EE3\u7801" tabindex="-1"><a class="header-anchor" href="#_1-1-\u5728orderserviceimpl\u4E2D\u52A0\u5F02\u5E38\u4EE3\u7801" aria-hidden="true">#</a> 1.1.\u5728OrderServiceImpl\u4E2D\u52A0\u5F02\u5E38\u4EE3\u7801</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u5728\u6DFB\u52A0\u8BA2\u5355\u4E0B\u52A0\u4E0A<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2.</span>checkout\u65B9\u6CD5\u7531<span class="token keyword">throws</span>\u5F02\u5E38<span class="token punctuation">,</span>\u6539\u6210<span class="token keyword">try</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">catch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderDao</span> orderDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderItemDao</span> orderItemDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">Cart</span> cart<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> orderSequence <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment">//1.\u521B\u5EFA\u8BA2\u5355\u5BF9\u8C61</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2.\u751F\u6210\u4E00\u4E2A\u552F\u4E00\u7684\u8BA2\u5355\u53F7(\u4F7F\u7528UUID)</span>
            orderSequence <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.\u5C06\u751F\u6210\u7684\u8BA2\u5355\u53F7\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D</span>
            order<span class="token punctuation">.</span><span class="token function">setOrderSequence</span><span class="token punctuation">(</span>orderSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.\u521B\u5EFA\u4E0B\u5355\u7684\u65F6\u95F4,\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D-&gt;\u5F53\u524D\u65F6\u95F4</span>
            <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> createTime <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>createTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//5.\u8BBE\u7F6EOrder\u7684\u8D2D\u4E70\u6570\u91CF,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
            order<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//6.\u8BBE\u7F6EOrder\u7684\u603B\u91D1\u989D,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
            order<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          7.\u8BBE\u7F6EOrder\u7684\u8BA2\u5355\u72B6\u6001 -&gt; \u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27:0

            \u6CE8\u610F:\u5C06\u6765\u5982\u679C\u5199\u72B6\u6001\u7801\u76F4\u63A5\u51990,\u4E0D\u597D
                \u5982\u679C\u5C06\u6765\u9879\u76EE\u7ECF\u7406\u6216\u8005\u4EA7\u54C1\u8BF4\u4E86:0\u4E0D\u4EE3\u8868\u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27\u4E86,\u54B1\u4EEC\u8FD8\u5F97\u6539\u8FD9\u4E2A0
                \u6240\u4EE5,\u72B6\u6001\u7801\u4E0D\u5E94\u8BE5\u5199\u6B7B

            \u89E3\u51B3:\u521B\u5EFA\u4E00\u4E2A\u7C7B,\u5728\u91CC\u9762\u521B\u5EFA\u72B6\u6001\u7801,\u5230\u65F6\u5019\u5982\u679C\u6574\u6570\u4EE3\u8868\u7684\u72B6\u6001\u6539\u4E86,\u6211\u4EEC\u76F4\u63A5\u5728\u6B64\u7C7B\u4E2D
                 \u6539
                 \u6B64\u5904\u7684\u4EE3\u7801\u4E0D\u7528\u6539\u4E86
         */</span>
            order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusCode</span><span class="token punctuation">.</span>YIZHIFU<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//8.\u8BBE\u7F6EOrder\u7684\u7528\u6237\u4E3B\u952E</span>
            order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//9.\u8C03\u7528dao\u6210\u7684insertOrder\u65B9\u6CD5,\u4F20\u9012Order\u5BF9\u8C61</span>
            <span class="token class-name">Integer</span> key <span class="token operator">=</span> orderDao<span class="token punctuation">.</span><span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
              <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=================\u4EE5\u4E0B\u662F\u8BA2\u5355\u9879\u7684\u4EE3\u7801================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
          10.\u7531\u4E8E\u8BA2\u5355\u9879\u4E2D\u7684\u5185\u5BB9\u53D6\u51B3\u4E8E\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u5185\u5BB9
             \u6240\u4EE5\u9700\u8981\u5148\u83B7\u53D6\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u6570\u636E
         */</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItem</span><span class="token punctuation">&gt;</span></span> cartItemCollection <span class="token operator">=</span> cart<span class="token punctuation">.</span><span class="token function">getCartItemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u6709\u51E0\u4E2A\u8D2D\u7269\u9879,\u5C31\u5E94\u8BE5\u6709\u51E0\u4E2A\u8BA2\u5355\u9879</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItem</span> cartItem <span class="token operator">:</span> cartItemCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>

          

                <span class="token comment">//\u521B\u5EFA\u8BA2\u5355\u9879\u5BF9\u8C61</span>
                <span class="token class-name">OrderItem</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6E\u8BA2\u5355\u9879OrderItem\u4E2D\u7684\u5C5E\u6027\u503C,\u5C5E\u6027\u503C\u4ECE\u8D2D\u7269\u9879\u4E2D\u53D6,\u7136\u540E\u653E\u5230OrderItem\u4E2D</span>

                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u4E66\u540D</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setBookName</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5355\u4EF7</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u56FE\u7247\u8DEF\u5F84</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setImgPath</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getImgPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8D2D\u4E70\u6570\u91CF</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setItemCount</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5C0F\u8BA1\u91D1\u989D</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setItemAmount</span><span class="token punctuation">(</span> cartItem<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/*
              orderItem\u4E2D\u7684order_id\u5916\u952E\u600E\u4E48\u4FDD\u5B58?
              \u83B7\u53D6\u6700\u540E\u4E00\u6B21\u65B0\u589E\u7684\u8BA2\u5355id
             */</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8BA2\u5355\u7684\u5916\u952E (\u8BA2\u5355\u6570\u636E\u8868\u7684\u4E3B\u952E)</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//\u8C03\u7528OrderItemDao\u4E2D\u7684\u6DFB\u52A0\u8BA2\u5355\u9879\u7684\u65B9\u6CD5</span>
                orderItemDao<span class="token punctuation">.</span><span class="token function">insertOrderItem</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> orderSequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u95EE\u9898<span class="token operator">:</span>
\u7531\u4E8E\u6211\u4EEC<span class="token keyword">catch</span>\u7684\u662F<span class="token class-name">Exception</span><span class="token punctuation">,</span>\u5565\u5F02\u5E38\u90FD\u80FD\u6293<span class="token punctuation">,</span>\u6293\u5230\u540E\u9762\u7684\u4EE3\u7801\u6B63\u5E38\u6267\u884C
\u6240\u4EE5\u53D1\u73B0\u6211\u4EEC\u7684\u8BA2\u5355\u63D0\u4EA4\u4E86<span class="token punctuation">,</span>\u4F46\u662F\u770B\u6570\u636E\u4E2Dt_order\u8868\u4E2D\u6709\u8BA2\u5355\u6570\u636E<span class="token punctuation">,</span>\u4F46\u662Ft_order_item\u8868\u4E2D\u6CA1\u6709\u8BA2\u5355\u9879\u6570\u636E
    
\u51FA\u73B0\u6570\u636E\u4E0D\u5B89\u5168\u7684\u95EE\u9898\u4E86
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://photo.sneoo.com/spring5/202207051131877.png" alt="image-20211201225314487" style="zoom:80%;"><blockquote><p>\u4EE5\u4E0A\u6DFB\u52A0\u8BA2\u5355\u548C\u6DFB\u52A0\u8BA2\u5355\u9879\u5176\u5B9E\u662F\u4E00\u7EC4\u64CD\u4F5C,\u8FD9\u4E00\u7EC4\u64CD\u4F5C\u8981\u4E48\u5168\u6210\u529F,\u8981\u4E48\u5C31\u5168\u5931\u8D25,\u53EF\u4EE5\u7528\u4E8B\u52A1\u63A7\u5236</p></blockquote><h2 id="_2-\u4E8B\u52A1\u7684\u5F15\u5165" tabindex="-1"><a class="header-anchor" href="#_2-\u4E8B\u52A1\u7684\u5F15\u5165" aria-hidden="true">#</a> 2.\u4E8B\u52A1\u7684\u5F15\u5165</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u6982\u8FF0<span class="token operator">:</span>\u4E00\u79CD\u7BA1\u7406\u4E00\u7EC4\u64CD\u4F5C<span class="token punctuation">(</span>\u591A\u6761sql<span class="token punctuation">)</span>\u7684\u6280\u672F
<span class="token number">2.</span>\u4F5C\u7528<span class="token operator">:</span>\u7BA1\u7406\u4E00\u7EC4\u64CD\u4F5C<span class="token punctuation">,</span>\u4F7F\u5176\u8981\u4E48\u5168\u6210\u529F<span class="token punctuation">,</span>\u8981\u4E48\u5168\u5931\u8D25
<span class="token number">3.</span>\u6CE8\u610F<span class="token operator">:</span>
  mysql\u81EA\u5E26\u4E8B\u52A1\u7BA1\u7406\u7684<span class="token punctuation">,</span>\u4F46\u662F\u4E00\u6B21\u53EA\u80FD\u7BA1\u7406\u4E00\u6761sql<span class="token punctuation">,</span>\u6240\u4EE5\u6211\u4EEC\u5E94\u8BE5\u624B\u52A8\u7BA1\u7406\u4E8B\u52A1
<span class="token number">4.</span>mysql\u4E2D\u7684\u4E8B\u52A1\u64CD\u4F5C<span class="token operator">:</span>
  begin  \u4E8B\u52A1\u5F00\u542F
  commit \u4E8B\u52A1\u63D0\u4EA4  <span class="token operator">-&gt;</span> \u5F53\u4E8B\u52A1\u63D0\u4EA4\u4E4B\u540E<span class="token punctuation">,</span>\u6570\u636E\u5C06\u6C38\u4E45\u4FDD\u5B58
  rollback \u4E8B\u52A1\u56DE\u6EDA <span class="token operator">-&gt;</span> \u5C06\u6570\u636E\u8FD4\u56DE\u5230\u4E0A\u6B21\u7684\u72B6\u6001
<span class="token number">5.</span>\u5982\u4F55\u5229\u7528java\u4EE3\u7801\u64CD\u4F5C\u4E8B\u52A1<span class="token operator">-&gt;</span><span class="token class-name">Connection</span>\u5BF9\u8C61
  a<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> \u5173\u95EDmysql\u81EA\u5E26\u4E8B\u52A1<span class="token punctuation">,</span>\u5F00\u542F\u624B\u52A8\u4E8B\u52A1
  b<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>\u63D0\u4EA4\u4E8B\u52A1<span class="token punctuation">,</span>\u6570\u636E\u5C06\u6C38\u4E45\u4FDD\u5B58
  c<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>\u56DE\u6EDA\u4E8B\u52A1<span class="token punctuation">,</span>\u6570\u636E\u8FD8\u539F
      
<span class="token number">6.</span>\u6CE8\u610F<span class="token operator">:</span>
  \u5982\u679C\u60F3\u8BA9\u4E8B\u52A1\u64CD\u4F5C\u4E00\u7EC4\u6570\u636E\u751F\u6548<span class="token punctuation">,</span>\u9700\u8981\u7528\u5230\u7684\u662F\u540C\u4E00\u4E2A<span class="token class-name">Connection</span>\u5BF9\u8C61
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> account<span class="token punctuation">(</span>
   <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   money <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- \u5F00\u542F\u4E8B\u52A1</span>
<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>

<span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> money <span class="token operator">=</span> money<span class="token operator">-</span><span class="token number">1000</span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token operator">=</span><span class="token string">&#39;\u6D9B\u54E5&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> money <span class="token operator">=</span> money<span class="token operator">+</span><span class="token number">1000</span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token operator">=</span><span class="token string">&#39;\u67F3\u5CA9&#39;</span><span class="token punctuation">;</span>


<span class="token comment">-- \u63D0\u4EA4\u4E8B\u52A1</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token comment">-- \u56DE\u6EDA\u4E8B\u52A1</span>
<span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u7531<span class="token class-name">OrderServletImpl</span>\u4E2D\u7684\u4EE3\u7801\u6211\u4EEC\u53D1\u73B0<span class="token operator">:</span>
 <span class="token number">1.</span>\u5C06\u8BA2\u5355\u653E\u5230\u8BA2\u5355\u8868\u4E2D\u8C03\u7528\u4E86<span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span>\u65B9\u6CD5
 <span class="token number">2.</span>\u5C06\u8BA2\u5355\u9879\u653E\u5230\u8BA2\u5355\u9879\u8868\u4E2D\u8C03\u7528\u4E86<span class="token function">insertOrderItem</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span>\u65B9\u6CD5
     
\u8FD9\u5C31\u4F1A\u6267\u884C<span class="token number">2</span>\u6761sql\u8BED\u53E5<span class="token punctuation">,</span>\u800C\u6BCF\u6761sql\u8BED\u53E5\u6267\u884C\u524D\u90FD\u5728\u5BF9\u5E94\u7684dao\u4E2D\u521B\u5EFA\u4E86<span class="token class-name">QueryRunner</span>\u5BF9\u8C61<span class="token punctuation">,</span>\u800C<span class="token class-name">Connection</span>\u5BF9\u8C61\u90FD\u662F\u4ECE\u8FDE\u63A5\u6C60<span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span>\u4E2D\u83B7\u53D6\u7684
     
\u5C31\u4F1A\u51FA\u73B0<span class="token number">2</span>\u6761sql\u4F7F\u7528<span class="token number">2</span>\u4E2A<span class="token class-name">Connection</span>\u8FDE\u63A5\u5BF9\u8C61
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020\u8BA2\u5355\u76F8\u5173\u7C7B" tabindex="-1"><a class="header-anchor" href="#_3-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020\u8BA2\u5355\u76F8\u5173\u7C7B" aria-hidden="true">#</a> 3.\u4F7F\u7528\u4E8B\u52A1\u6539\u9020\u8BA2\u5355\u76F8\u5173\u7C7B</h2><h3 id="_3-1-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020orderserviceimpl" tabindex="-1"><a class="header-anchor" href="#_3-1-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020orderserviceimpl" aria-hidden="true">#</a> 3.1.\u4F7F\u7528\u4E8B\u52A1\u6539\u9020OrderServiceImpl</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderDao</span> orderDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderItemDao</span> orderItemDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">Cart</span> cart<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u4ECE\u8FDE\u63A5\u6C60\u4E2D\u83B7\u53D6\u8FDE\u63A5</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> orderSequence <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            connection <span class="token operator">=</span> <span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u5F00\u542F\u4E8B\u52A1</span>
            connection<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//1.\u521B\u5EFA\u8BA2\u5355\u5BF9\u8C61</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2.\u751F\u6210\u4E00\u4E2A\u552F\u4E00\u7684\u8BA2\u5355\u53F7(\u4F7F\u7528UUID)</span>
            orderSequence <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.\u5C06\u751F\u6210\u7684\u8BA2\u5355\u53F7\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D</span>
            order<span class="token punctuation">.</span><span class="token function">setOrderSequence</span><span class="token punctuation">(</span>orderSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.\u521B\u5EFA\u4E0B\u5355\u7684\u65F6\u95F4,\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D-&gt;\u5F53\u524D\u65F6\u95F4</span>
            <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> createTime <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>createTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//5.\u8BBE\u7F6EOrder\u7684\u8D2D\u4E70\u6570\u91CF,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
            order<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//6.\u8BBE\u7F6EOrder\u7684\u603B\u91D1\u989D,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
            order<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          7.\u8BBE\u7F6EOrder\u7684\u8BA2\u5355\u72B6\u6001 -&gt; \u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27:0

            \u6CE8\u610F:\u5C06\u6765\u5982\u679C\u5199\u72B6\u6001\u7801\u76F4\u63A5\u51990,\u4E0D\u597D
                \u5982\u679C\u5C06\u6765\u9879\u76EE\u7ECF\u7406\u6216\u8005\u4EA7\u54C1\u8BF4\u4E86:0\u4E0D\u4EE3\u8868\u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27\u4E86,\u54B1\u4EEC\u8FD8\u5F97\u6539\u8FD9\u4E2A0
                \u6240\u4EE5,\u72B6\u6001\u7801\u4E0D\u5E94\u8BE5\u5199\u6B7B

            \u89E3\u51B3:\u521B\u5EFA\u4E00\u4E2A\u7C7B,\u5728\u91CC\u9762\u521B\u5EFA\u72B6\u6001\u7801,\u5230\u65F6\u5019\u5982\u679C\u6574\u6570\u4EE3\u8868\u7684\u72B6\u6001\u6539\u4E86,\u6211\u4EEC\u76F4\u63A5\u5728\u6B64\u7C7B\u4E2D
                 \u6539
                 \u6B64\u5904\u7684\u4EE3\u7801\u4E0D\u7528\u6539\u4E86
         */</span>
            order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusCode</span><span class="token punctuation">.</span>YIZHIFU<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//8.\u8BBE\u7F6EOrder\u7684\u7528\u6237\u4E3B\u952E</span>
            order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//9.\u8C03\u7528dao\u6210\u7684insertOrder\u65B9\u6CD5,\u4F20\u9012Order\u5BF9\u8C61</span>
            <span class="token class-name">Integer</span> key <span class="token operator">=</span> orderDao<span class="token punctuation">.</span><span class="token function">insertOrder</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
             <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=================\u4EE5\u4E0B\u662F\u8BA2\u5355\u9879\u7684\u4EE3\u7801================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
          10.\u7531\u4E8E\u8BA2\u5355\u9879\u4E2D\u7684\u5185\u5BB9\u53D6\u51B3\u4E8E\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u5185\u5BB9
             \u6240\u4EE5\u9700\u8981\u5148\u83B7\u53D6\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u6570\u636E
         */</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItem</span><span class="token punctuation">&gt;</span></span> cartItemCollection <span class="token operator">=</span> cart<span class="token punctuation">.</span><span class="token function">getCartItemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u6709\u51E0\u4E2A\u8D2D\u7269\u9879,\u5C31\u5E94\u8BE5\u6709\u51E0\u4E2A\u8BA2\u5355\u9879</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItem</span> cartItem <span class="token operator">:</span> cartItemCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">//\u521B\u5EFA\u8BA2\u5355\u9879\u5BF9\u8C61</span>
                <span class="token class-name">OrderItem</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6E\u8BA2\u5355\u9879OrderItem\u4E2D\u7684\u5C5E\u6027\u503C,\u5C5E\u6027\u503C\u4ECE\u8D2D\u7269\u9879\u4E2D\u53D6,\u7136\u540E\u653E\u5230OrderItem\u4E2D</span>

                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u4E66\u540D</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setBookName</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5355\u4EF7</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u56FE\u7247\u8DEF\u5F84</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setImgPath</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getImgPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8D2D\u4E70\u6570\u91CF</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setItemCount</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5C0F\u8BA1\u91D1\u989D</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setItemAmount</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/*
              orderItem\u4E2D\u7684order_id\u5916\u952E\u600E\u4E48\u4FDD\u5B58?
              \u83B7\u53D6\u6700\u540E\u4E00\u6B21\u65B0\u589E\u7684\u8BA2\u5355id
             */</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8BA2\u5355\u7684\u5916\u952E (\u8BA2\u5355\u6570\u636E\u8868\u7684\u4E3B\u952E)</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//\u8C03\u7528OrderItemDao\u4E2D\u7684\u6DFB\u52A0\u8BA2\u5355\u9879\u7684\u65B9\u6CD5</span>
                orderItemDao<span class="token punctuation">.</span><span class="token function">insertOrderItem</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token comment">//\u63D0\u4EA4\u4E8B\u52A1</span>
                connection<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u4E8B\u52A1\u56DE\u6EDA</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> orderSequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020orderdao" tabindex="-1"><a class="header-anchor" href="#_3-2-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020orderdao" aria-hidden="true">#</a> 3.2.\u4F7F\u7528\u4E8B\u52A1\u6539\u9020OrderDao</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderDao</span> <span class="token punctuation">{</span>
    <span class="token class-name">Integer</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">,</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderDao</span> <span class="token punctuation">{</span>
   <span class="token class-name">QueryRunner</span> qr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryRunner</span><span class="token punctuation">(</span><span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * \u6DFB\u52A0\u8BA2\u5355\u65B9\u6CD5
     * <span class="token keyword">@param</span> <span class="token parameter">order</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">,</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into t_order values (?,?,?,?,?,?,?)&quot;</span><span class="token punctuation">;</span>
        qr<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>sql<span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                order<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u83B7\u53D6\u65B0\u589E\u7684\u4E3B\u952E</span>
        <span class="token class-name">String</span> sqlKey <span class="token operator">=</span> <span class="token string">&quot;select last_insert_id()&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          \u6267\u884Cselect last_insert_id()\u9700\u8981\u8F6C\u6210BigInteger
          \u5F3A\u8F6C\u6210BigInteger\u8C03\u7528intValue()\u8F6C\u6210Integer
         */</span>
        <span class="token class-name">Integer</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">)</span> qr<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>sqlKey<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScalarHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020orderitemdao" tabindex="-1"><a class="header-anchor" href="#_3-3-\u4F7F\u7528\u4E8B\u52A1\u6539\u9020orderitemdao" aria-hidden="true">#</a> 3.3.\u4F7F\u7528\u4E8B\u52A1\u6539\u9020OrderItemDao</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderItemDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">,</span> <span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderItemDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderItemDao</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryRunner</span> qr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryRunner</span><span class="token punctuation">(</span><span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">,</span><span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
<span class="token comment">//\u5199\u5165\u4E2D\u95F4\u8868\u7684SQL\u6570\u636E</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into t_order_item values(?,?,?,?,?,?,?)&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5BF9\u8C61\u6570\u7EC4\uFF0C\u5B58\u50A8\u4E2D\u95F4\u8868\u95EE\u53F7\u5360\u4F4D\u7B26\u6570\u636E</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>orderItem<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                orderItem<span class="token punctuation">.</span><span class="token function">getImgPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getItemAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//\u6267\u884CSQL\u8BED\u53E5</span>
        qr<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u95EE\u9898:</p><p>1.\u53D1\u73B0\u5982\u679C\u7A0B\u5E8F\u6709\u95EE\u9898\u4E86,\u4E8B\u52A1\u63A7\u5236\u4E4B\u540E,t_order\u548Ct_orderitem\u4E24\u4E2A\u8868\u4E2D\u90FD\u6CA1\u6709\u6570\u636E\u4E86</p><p>2.\u4F46\u662F\u8BA2\u5355\u53F7\u8FD8\u662F\u6709,\u600E\u4E48\u89E3\u51B3?</p></blockquote><h3 id="_3-4-\u8BA2\u5355\u63D0\u4EA4\u5931\u8D25-\u5904\u7406\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#_3-4-\u8BA2\u5355\u63D0\u4EA4\u5931\u8D25-\u5904\u7406\u65B9\u5F0F" aria-hidden="true">#</a> 3.4.\u8BA2\u5355\u63D0\u4EA4\u5931\u8D25,\u5904\u7406\u65B9\u5F0F</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u4FEE\u6539<span class="token class-name">OrderServiceImpl</span><span class="token punctuation">,</span>\u5728\u56DE\u6EDA\u4E4B\u524D\u628Auuid\u53D8\u4E3A<span class="token keyword">null</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orderSequence <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//\u4E8B\u52A1\u56DE\u6EDA</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">2.</span>\u4FEE\u6539<span class="token class-name">OrderServlet</span>\u7AEF\u63A5\u6536\u5230\u7684\u8BA2\u5355\u53F7\u662F\u5426\u4E3A\u7A7A
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> orderSequence <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.\u4ECEsession\u4E2D\u83B7\u53D6\u8D2D\u7269\u8F66\u5BF9\u8C61</span>
            <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Cart</span> cart <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Cart</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2.\u4ECEsession\u83B7\u53D6\u7528\u6237\u4FE1\u606F</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.\u8C03\u7528service\u5C42\u7684\u65B9\u6CD5,\u8FDB\u884C\u8BA2\u5355\u7ED3\u7B97,\u5E76\u4E14\u83B7\u53D6\u8BA2\u5355\u7684\u5E8F\u5217\u53F7</span>
            orderSequence <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">checkout</span><span class="token punctuation">(</span>cart<span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>orderSequence<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//4.\u6E05\u7A7A\u8D2D\u7269\u8F66</span>
                <span class="token comment">//session.removeAttribute(&quot;cart&quot;);</span>
                cart<span class="token punctuation">.</span><span class="token function">getCartItemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cart<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//5.\u5C06\u8BA2\u5355\u5E8F\u5217\u53F7\u5B58\u50A8\u5230\u57DF\u4E2D,\u8DF3\u8F6Ccheckout.html\u9875\u9762</span>
                request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orderSequence&quot;</span><span class="token punctuation">,</span>orderSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">processTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;cart/checkout&quot;</span><span class="token punctuation">,</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orderSequence&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u5BF9\u4E0D\u8D77,\u8BA2\u5355\u5931\u8D25&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">processTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;cart/checkout&quot;</span><span class="token punctuation">,</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u95EE\u9898:</p><p>Service\u53EA\u662F\u5904\u7406\u4E1A\u52A1\u7684,\u800C\u83B7\u53D6\u8FDE\u63A5\u5BF9\u8C61,\u4F20\u9012\u8FDE\u63A5\u5BF9\u8C61\u64CD\u4F5C\u4E0D\u5E94\u8BE5Service\u5E72\u7684\u4E8B\u513F</p><p>\u83B7\u53D6\u8FDE\u63A5\u8FD9\u4E2A\u4E8B\u513F\u4E0D\u662F\u5E94\u8BE5Service\u5C42\u5E72,\u5C06\u8FDE\u63A5\u5BF9\u8C61\u4F20\u9012\u7ED9dao\u5C42\u4E5F\u4E0D\u5E94\u8BE5\u662FService\u5E72\u7684\u4E8B\u513F</p><p>\u83B7\u53D6\u8FDE\u63A5\u4F20\u9012\u8FDE\u63A5\u4E0D\u5E94\u8BE5\u5728service\u5C42\u5E72,\u8FD9\u4EF6\u4E8B\u4ECEservice\u5C42\u62BD\u79BB\u51FA\u6765,\u4F46\u662F\u8FD8\u8981 \u4FDD\u8BC1service\u548Cdao\u5C42\u4F7F\u7528\u7684\u8FDE\u63A5\u5BF9\u8C61\u662F\u540C\u4E00\u6761\u8FDE\u63A5</p></blockquote><h2 id="_4-threadlocal\u5BF9\u8C61\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#_4-threadlocal\u5BF9\u8C61\u4ECB\u7ECD" aria-hidden="true">#</a> 4.ThreadLocal\u5BF9\u8C61\u4ECB\u7ECD</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u95EE\u9898\u63CF\u8FF0<span class="token operator">:</span>
  a<span class="token punctuation">.</span>\u5982\u4F55\u4FDD\u8BC1<span class="token class-name">Service</span>\u5C42\u4E0D\u7ED9dao\u5C42\u4F20\u9012\u8FDE\u63A5\u5BF9\u8C61\u65F6<span class="token punctuation">,</span>\u4F7F\u7528\u7684\u662F \u540C\u4E00\u6761\u8FDE\u63A5\u5462
  b<span class="token punctuation">.</span>\u4E00\u4E2A\u7528\u6237\u5C31\u662F\u4E00\u4E2A\u7EBF\u7A0B<span class="token punctuation">,</span>\u90A3\u4E48\u5728\u540C\u4E00\u6761\u7EBF\u7A0B\u4E2D\u4FDD\u8BC1\u8FDE\u63A5\u5BF9\u5E94\u662F\u540C\u4E00\u4E2A\u5462<span class="token punctuation">,</span>\u600E\u4E48\u5C06\u8FDE\u63A5\u5BF9\u8C61\u548C\u7EBF\u7A0B\u7ED1\u5728\u4E00\u8D77\u5462<span class="token operator">?</span>
    \u8FD9\u6837\u4E0D\u7BA1\u7528\u6237\u53BB\u54EA\u91CC<span class="token punctuation">,</span>\u4F7F\u7528\u7684\u8FDE\u63A5\u90FD\u662F\u540C\u4E00\u4E2A\u8FDE\u63A5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span>\u6982\u8FF0<span class="token operator">:</span>\u5BB9\u5668
<span class="token number">2.</span>\u65B9\u6CD5<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span>  <span class="token operator">-&gt;</span>\u5F80<span class="token class-name">ThreadLocal</span>\u4E2D\u6DFB\u52A0\u5143\u7D20
    <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">-&gt;</span> \u4ECE<span class="token class-name">ThreadLocal</span>\u4E2D\u83B7\u53D6\u5143\u7D20
    
<span class="token number">3.</span>\u7279\u70B9<span class="token operator">:</span>
   <span class="token class-name"><span class="token namespace">a<span class="token punctuation">.</span></span>ThreadLocal</span>\u4E2D\u83B7\u53D6\u7684\u5143\u7D20\u90FD\u662F\u6700\u540E\u4E00\u6B21\u5B58\u8FDB\u53BB\u7684<span class="token punctuation">,</span>\u4E00\u6B21\u53EA\u80FD\u5B58\u4E00\u4E2A
   b<span class="token punctuation">.</span>\u4E00\u4E2A\u7EBF\u7A0B\u5F80<span class="token class-name">ThreadLocal</span>\u4E2D\u5B58\u50A8\u6570\u636E<span class="token punctuation">,</span>\u5176\u4ED6\u7EBF\u7A0B\u83B7\u53D6\u4E0D\u5230
       
<span class="token number">4.</span>\u4F5C\u7528<span class="token operator">:</span>\u4FDD\u8BC1\u4E00\u6761\u7EBF\u7A0B\u4E2D\u4F7F\u7528\u7684\u8D44\u6E90\u662F\u540C\u4E00\u4E2A
    
<span class="token number">5.</span>\u5E95\u5C42\u5B9E\u8D28\u4E0A\u662F\u4E00\u4E2Amap\u96C6\u5408
  key<span class="token operator">:</span>\u5F53\u524D\u7EBF\u7A0B\u5BF9\u8C61  <span class="token operator">-&gt;</span>  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  value<span class="token operator">:</span>\u968F\u610F  <span class="token operator">-&gt;</span>  \u5B58\u5728<span class="token class-name">ThreadLocal</span>\u4E2D\u7684\u503C
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u521B\u5EFAThreadLocal\u5BF9\u8C61</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;\u591A\u5C14\u886E&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//null</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-\u8FDE\u63A5\u7BA1\u7406\u7C7B" tabindex="-1"><a class="header-anchor" href="#_5-\u8FDE\u63A5\u7BA1\u7406\u7C7B" aria-hidden="true">#</a> 5.\u8FDE\u63A5\u7BA1\u7406\u7C7B</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *  \u4F7F\u7528ThreadLocal\u7C7B\uFF0C\u5C06\u7EBF\u7A0B\u5BF9\u8C61\uFF0C\u548C\u6570\u636E\u5E93\u8FDE\u63A5\u5BF9\u8C61\u5B9E\u73B0\u7ED1\u5B9A
 *  \u4FDD\u8BC1\u4E00\u4E2A\u7528\u6237\u4E00\u4E2A\u7EBF\u7A0B
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u5B9A\u4E49\u5BF9\u8C61ThreadLocal</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> local <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u65B9\u6CD5\uFF0C\u91CA\u653E\u8D44\u6E90
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u7EBF\u7A0B\u5BF9\u8C61\u548C\u8FDE\u63A5\u5BF9\u8C61\u89E3\u9664\u7ED1\u5B9A</span>
            <span class="token comment">//Map\u96C6\u5408\uFF0C\u79FB\u9664\u952E\u503C\u5BF9</span>
            local<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u91CA\u653E\u8D44\u6E90\uFF0C\u8FDE\u63A5\u5BF9\u8C61\uFF0C\u5F52\u8FD8\u8FDE\u63A5\u6C60</span>
            <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * \u65B9\u6CD5\uFF1A\u56DE\u6EDA\u4E8B\u52A1
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u65B9\u6CD5:\u63D0\u4EA4\u4E8B\u52A1
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * \u65B9\u6CD5\uFF1A\u5F00\u542F\u4E8B\u52A1\u7684\u65B9\u6CD5
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     *  \u65B9\u6CD5\uFF1A\u8FD4\u56DE\u6570\u636E\u5E93\u7684\u8FDE\u63A5\u5BF9\u8C61
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u4ECElocal\u5BF9\u8C61\u4E2D\uFF0C\u83B7\u53D6\u6570\u636E\u5E93\u8FDE\u63A5\u5BF9\u8C61</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5224\u65AD\u8FDE\u63A5\u5BF9\u8C61\uFF0C\u662F\u5426\u5B58\u5728</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>con <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//local\u5BF9\u8C61\u4E2D\uFF0C\u6CA1\u6709\u5B58\u50A8\u8FC7\u8FDE\u63A5\u5BF9\u8C61</span>
            <span class="token comment">//\u8FDE\u63A5\u6C60\u62FF\u4E00\u4E2A</span>
            con <span class="token operator">=</span> <span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u5B58\u50A8\u5230local\u5BF9\u8C61</span>
            local<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> con<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-\u4F7F\u7528\u8FDE\u63A5\u7BA1\u7406\u7C7B\u6539\u9020orderservice\u548Corderdao\u4EE5\u53CAorderitemdao" tabindex="-1"><a class="header-anchor" href="#_6-\u4F7F\u7528\u8FDE\u63A5\u7BA1\u7406\u7C7B\u6539\u9020orderservice\u548Corderdao\u4EE5\u53CAorderitemdao" aria-hidden="true">#</a> 6.\u4F7F\u7528\u8FDE\u63A5\u7BA1\u7406\u7C7B\u6539\u9020OrderService\u548COrderDao\u4EE5\u53CAOrderItemDao</h2><h3 id="_6-1-\u4FEE\u6539orderservice" tabindex="-1"><a class="header-anchor" href="#_6-1-\u4FEE\u6539orderservice" aria-hidden="true">#</a> 6.1.\u4FEE\u6539OrderService</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderDao</span> orderDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderItemDao</span> orderItemDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token class-name">Cart</span> cart<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> orderSequence <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u5F00\u542F\u4E8B\u52A1</span>
            <span class="token class-name">ConnectionManager</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//1.\u521B\u5EFA\u8BA2\u5355\u5BF9\u8C61</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2.\u751F\u6210\u4E00\u4E2A\u552F\u4E00\u7684\u8BA2\u5355\u53F7(\u4F7F\u7528UUID)</span>
            orderSequence <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.\u5C06\u751F\u6210\u7684\u8BA2\u5355\u53F7\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D</span>
            order<span class="token punctuation">.</span><span class="token function">setOrderSequence</span><span class="token punctuation">(</span>orderSequence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.\u521B\u5EFA\u4E0B\u5355\u7684\u65F6\u95F4,\u5C01\u88C5\u5230Order\u5BF9\u8C61\u4E2D-&gt;\u5F53\u524D\u65F6\u95F4</span>
            <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> createTime <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>createTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//5.\u8BBE\u7F6EOrder\u7684\u8D2D\u4E70\u6570\u91CF,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
            order<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//6.\u8BBE\u7F6EOrder\u7684\u603B\u91D1\u989D,\u6765\u81EA\u4E8E\u8D2D\u7269\u8F66</span>
            order<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          7.\u8BBE\u7F6EOrder\u7684\u8BA2\u5355\u72B6\u6001 -&gt; \u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27:0

            \u6CE8\u610F:\u5C06\u6765\u5982\u679C\u5199\u72B6\u6001\u7801\u76F4\u63A5\u51990,\u4E0D\u597D
                \u5982\u679C\u5C06\u6765\u9879\u76EE\u7ECF\u7406\u6216\u8005\u4EA7\u54C1\u8BF4\u4E86:0\u4E0D\u4EE3\u8868\u5DF2\u652F\u4ED8,\u5F85\u53D1\u8D27\u4E86,\u54B1\u4EEC\u8FD8\u5F97\u6539\u8FD9\u4E2A0
                \u6240\u4EE5,\u72B6\u6001\u7801\u4E0D\u5E94\u8BE5\u5199\u6B7B

            \u89E3\u51B3:\u521B\u5EFA\u4E00\u4E2A\u7C7B,\u5728\u91CC\u9762\u521B\u5EFA\u72B6\u6001\u7801,\u5230\u65F6\u5019\u5982\u679C\u6574\u6570\u4EE3\u8868\u7684\u72B6\u6001\u6539\u4E86,\u6211\u4EEC\u76F4\u63A5\u5728\u6B64\u7C7B\u4E2D
                 \u6539
                 \u6B64\u5904\u7684\u4EE3\u7801\u4E0D\u7528\u6539\u4E86
         */</span>
            order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusCode</span><span class="token punctuation">.</span>YIZHIFU<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//8.\u8BBE\u7F6EOrder\u7684\u7528\u6237\u4E3B\u952E</span>
            order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//9.\u8C03\u7528dao\u6210\u7684insertOrder\u65B9\u6CD5,\u4F20\u9012Order\u5BF9\u8C61</span>
            <span class="token class-name">Integer</span> key <span class="token operator">=</span> orderDao<span class="token punctuation">.</span><span class="token function">insertOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=================\u4EE5\u4E0B\u662F\u8BA2\u5355\u9879\u7684\u4EE3\u7801================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
          10.\u7531\u4E8E\u8BA2\u5355\u9879\u4E2D\u7684\u5185\u5BB9\u53D6\u51B3\u4E8E\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u5185\u5BB9
             \u6240\u4EE5\u9700\u8981\u5148\u83B7\u53D6\u8D2D\u7269\u8F66\u4E2D\u8D2D\u7269\u9879\u7684\u6570\u636E
         */</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItem</span><span class="token punctuation">&gt;</span></span> cartItemCollection <span class="token operator">=</span> cart<span class="token punctuation">.</span><span class="token function">getCartItemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u6709\u51E0\u4E2A\u8D2D\u7269\u9879,\u5C31\u5E94\u8BE5\u6709\u51E0\u4E2A\u8BA2\u5355\u9879</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItem</span> cartItem <span class="token operator">:</span> cartItemCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">//\u521B\u5EFA\u8BA2\u5355\u9879\u5BF9\u8C61</span>
                <span class="token class-name">OrderItem</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6E\u8BA2\u5355\u9879OrderItem\u4E2D\u7684\u5C5E\u6027\u503C,\u5C5E\u6027\u503C\u4ECE\u8D2D\u7269\u9879\u4E2D\u53D6,\u7136\u540E\u653E\u5230OrderItem\u4E2D</span>

                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u4E66\u540D</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setBookName</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5355\u4EF7</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u56FE\u7247\u8DEF\u5F84</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setImgPath</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getImgPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8D2D\u4E70\u6570\u91CF</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setItemCount</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u5C0F\u8BA1\u91D1\u989D</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setItemAmount</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/*
              orderItem\u4E2D\u7684order_id\u5916\u952E\u600E\u4E48\u4FDD\u5B58?
              \u83B7\u53D6\u6700\u540E\u4E00\u6B21\u65B0\u589E\u7684\u8BA2\u5355id
             */</span>
                <span class="token comment">//\u8BBE\u7F6EorderItem\u5BF9\u8C61\u7684\u53C2\u6570\uFF1A\u8BA2\u5355\u7684\u5916\u952E (\u8BA2\u5355\u6570\u636E\u8868\u7684\u4E3B\u952E)</span>
                orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//\u8C03\u7528OrderItemDao\u4E2D\u7684\u6DFB\u52A0\u8BA2\u5355\u9879\u7684\u65B9\u6CD5</span>
                orderItemDao<span class="token punctuation">.</span><span class="token function">insertOrderItem</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//\u63D0\u4EA4\u4E8B\u52A1</span>
            <span class="token class-name">ConnectionManager</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderSequence <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token comment">//\u4E8B\u52A1\u56DE\u6EDA</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">ConnectionManager</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token class-name">ConnectionManager</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> orderSequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-\u4FEE\u6539orderdao" tabindex="-1"><a class="header-anchor" href="#_6-2-\u4FEE\u6539orderdao" aria-hidden="true">#</a> 6.2.\u4FEE\u6539OrderDao</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderDao</span> <span class="token punctuation">{</span>
    <span class="token class-name">Integer</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderDao</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryRunner</span> qr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryRunner</span><span class="token punctuation">(</span><span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * \u6DFB\u52A0\u8BA2\u5355\u65B9\u6CD5
     * <span class="token keyword">@param</span> <span class="token parameter">order</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">insertOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into t_order values (?,?,?,?,?,?,?)&quot;</span><span class="token punctuation">;</span>
        qr<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">ConnectionManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sql<span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                order<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u83B7\u53D6\u65B0\u589E\u7684\u4E3B\u952E</span>
        <span class="token class-name">String</span> sqlKey <span class="token operator">=</span> <span class="token string">&quot;select last_insert_id()&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          \u6267\u884Cselect last_insert_id()\u9700\u8981\u8F6C\u6210BigInteger
          \u5F3A\u8F6C\u6210BigInteger\u8C03\u7528intValue()\u8F6C\u6210Integer
         */</span>
        <span class="token class-name">Integer</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">)</span> qr<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">ConnectionManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sqlKey<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScalarHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-\u4FEE\u6539orderitemdao" tabindex="-1"><a class="header-anchor" href="#_6-3-\u4FEE\u6539orderitemdao" aria-hidden="true">#</a> 6.3.\u4FEE\u6539OrderItemDao</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderItemDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span> <span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderItemDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderItemDao</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryRunner</span> qr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryRunner</span><span class="token punctuation">(</span><span class="token class-name">DruidUtils</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrderItem</span><span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
<span class="token comment">//\u5199\u5165\u4E2D\u95F4\u8868\u7684SQL\u6570\u636E</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into t_order_item values(?,?,?,?,?,?,?)&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5BF9\u8C61\u6570\u7EC4\uFF0C\u5B58\u50A8\u4E2D\u95F4\u8868\u95EE\u53F7\u5360\u4F4D\u7B26\u6570\u636E</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>orderItem<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                orderItem<span class="token punctuation">.</span><span class="token function">getImgPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getItemAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderItem<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//\u6267\u884CSQL\u8BED\u53E5</span>
        qr<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">ConnectionManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,108),o=[p];function c(l,i){return s(),a("div",null,o)}var r=n(e,[["render",c],["__file","day14_\u4E66\u57CE\u9879\u76EE\u7B2C\u516D\u9636\u6BB5.html.vue"]]);export{r as default};
